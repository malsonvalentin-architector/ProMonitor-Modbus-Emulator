<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ProMonitor v2.0 - Real-Time HVAC Dashboard</title>
    
    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    
    <!-- Socket.IO Client -->
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .main-container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .header {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }
        
        .header h1 {
            color: #667eea;
            font-weight: 700;
            margin: 0;
            font-size: 2.5rem;
        }
        
        .header p {
            color: #666;
            margin: 10px 0 0 0;
            font-size: 1.1rem;
        }
        
        .connection-controls {
            margin-top: 15px;
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .connection-status {
            display: inline-block;
            padding: 8px 20px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.9rem;
        }
        
        .connection-status.connected {
            background: #10b981;
            color: white;
        }
        
        .connection-status.disconnected {
            background: #ef4444;
            color: white;
        }
        
        .connection-status.paused {
            background: #f59e0b;
            color: white;
        }
        
        .btn-pause {
            padding: 8px 20px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.9rem;
            background: #3b82f6;
            color: white;
            border: none;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-pause:hover {
            background: #2563eb;
            transform: scale(1.05);
        }
        
        /* Control Panel Styles */
        .control-panel-header {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            margin-bottom: 30px;
        }
        
        .control-panel-header h2 {
            color: #667eea;
            font-weight: 700;
            margin-bottom: 10px;
            text-align: center;
        }
        
        .control-panel-header p {
            text-align: center;
            color: #666;
            margin: 0;
        }
        
        .scenarios-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .scenario-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            border: 3px solid transparent;
        }
        
        .scenario-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
        }
        
        .scenario-card.active {
            border-color: #10b981;
            background: rgba(255, 255, 255, 0.95);  /* Keep white background! */
            animation: pulse-glow 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { box-shadow: 0 5px 15px rgba(16, 185, 129, 0.3); }
            50% { box-shadow: 0 10px 30px rgba(16, 185, 129, 0.5); }
        }
        
        @keyframes pulse-glow {
            0%, 100% { 
                box-shadow: 0 0 20px rgba(16, 185, 129, 0.4),
                            0 0 40px rgba(16, 185, 129, 0.2),
                            0 5px 15px rgba(0, 0, 0, 0.1);
            }
            50% { 
                box-shadow: 0 0 30px rgba(16, 185, 129, 0.6),
                            0 0 60px rgba(16, 185, 129, 0.3),
                            0 10px 30px rgba(0, 0, 0, 0.15);
            }
        }
        
        .scenario-icon {
            font-size: 3rem;
            margin-bottom: 15px;
            text-align: center;
        }
        
        .scenario-name {
            font-size: 1.3rem;
            font-weight: 700;
            color: #333;
            margin-bottom: 10px;
            text-align: center;
        }
        
        .scenario-description {
            color: #666;
            font-size: 0.95rem;
            margin-bottom: 20px;
            text-align: center;
            min-height: 40px;
        }
        
        .sensor-select {
            width: 100%;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 1rem;
            background: white;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .sensor-select:hover {
            border-color: #667eea;
        }
        
        .sensor-select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        /* Intensity Slider Styles */
        .intensity-container {
            margin: 15px 0;
        }
        
        .intensity-label {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            font-size: 0.9rem;
            color: #666;
        }
        
        .intensity-value {
            font-weight: 700;
            color: #667eea;
            font-size: 1rem;
        }
        
        .intensity-slider {
            width: 100%;
            height: 8px;
            border-radius: 5px;
            background: linear-gradient(to right, #e0e0e0 0%, #667eea 100%);
            outline: none;
            -webkit-appearance: none;
            margin-bottom: 5px;
        }
        
        .intensity-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #667eea;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            transition: all 0.2s;
        }
        
        .intensity-slider::-webkit-slider-thumb:hover {
            background: #764ba2;
            transform: scale(1.2);
            box-shadow: 0 3px 8px rgba(102, 126, 234, 0.4);
        }
        
        .intensity-slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #667eea;
            cursor: pointer;
            border: none;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            transition: all 0.2s;
        }
        
        .intensity-slider::-moz-range-thumb:hover {
            background: #764ba2;
            transform: scale(1.2);
            box-shadow: 0 3px 8px rgba(102, 126, 234, 0.4);
        }
        
        .intensity-range {
            display: flex;
            justify-content: space-between;
            font-size: 0.75rem;
            color: #999;
        }
        
        .scenario-controls {
            display: flex;
            gap: 10px;
        }
        
        .btn-trigger {
            flex: 1;
            padding: 12px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-trigger:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .btn-stop {
            flex: 1;
            padding: 12px;
            background: #ef4444;
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-stop:hover {
            background: #dc2626;
            transform: scale(1.05);
        }
        
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .metric-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s;
        }
        
        .metric-card:hover {
            transform: translateY(-5px);
        }
        
        .metric-icon {
            font-size: 3rem;
            margin-bottom: 15px;
            text-align: center;
        }
        
        .metric-value {
            font-size: 2rem;
            font-weight: 700;
            color: #667eea;
            text-align: center;
            margin-bottom: 10px;
        }
        
        .metric-label {
            font-size: 1rem;
            color: #666;
            text-align: center;
            margin-bottom: 5px;
        }
        
        .metric-average {
            font-size: 0.85rem;
            color: #999;
            text-align: center;
        }
        
        /* Building Cards Styles */
        .buildings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .building-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }
        
        .building-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
        }
        
        .building-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #f0f0f0;
        }
        
        .building-icon {
            font-size: 1.5rem;
        }
        
        .building-title {
            font-size: 1.1rem;
            font-weight: 700;
            color: #667eea;
            flex: 1;
            margin-left: 10px;
        }
        
        .building-status {
            font-size: 1.2rem;
        }
        
        .status-normal {
            color: #10b981;
        }
        
        .status-warning {
            color: #f59e0b;
        }
        
        .status-critical {
            color: #ef4444;
        }
        
        .building-metrics {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 12px;
        }
        
        .building-metric {
            display: flex;
            align-items: center;
            font-size: 0.9rem;
        }
        
        .building-metric .metric-icon {
            font-size: 1.2rem;
            margin-right: 8px;
            margin-bottom: 0;
        }
        
        .building-metric .metric-text {
            font-weight: 600;
            color: #333;
        }
        
        .building-sensors {
            font-size: 0.85rem;
            color: #666;
            text-align: center;
            padding: 8px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 10px;
        }
        
        .building-scenario-badge {
            background: linear-gradient(135deg, #f59e0b 0%, #ef4444 100%);
            color: white;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 0.8rem;
            font-weight: 600;
            text-align: center;
            animation: badge-pulse 2s infinite;
        }
        
        @keyframes badge-pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        .charts-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 20px;
        }
        
        .chart-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
        .chart-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .chart-title {
            font-size: 1.3rem;
            font-weight: 700;
            color: #333;
            margin: 0;
        }
        
        .chart-subtitle {
            font-size: 0.85rem;
            color: #999;
        }
        
        @media (max-width: 768px) {
            .charts-container {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 1.8rem;
            }
        }
    </style>
</head>
<body>
    <div class="main-container">
        <!-- Header -->
        <div class="header">
            <h1>🚀 ProMonitor v2.0 Real-Time Dashboard</h1>
            <p>Система мониторинга HVAC с интерактивным эмулятором сценариев</p>
            <div class="connection-controls">
                <div class="connection-status disconnected" id="connectionStatus">
                    <span id="statusText">Подключение...</span>
                </div>
                <button class="btn-pause" id="pauseBtn" onclick="togglePause()">
                    <span id="pauseText">⏸ Приостановить</span>
                </button>
            </div>
        </div>
        
        <!-- Control Panel -->
        <div class="control-panel" style="margin-bottom: 30px;">
            <div class="control-panel-header">
                <h2>🎮 Панель Управления Сценариями</h2>
                <p>Выберите датчик и запустите сценарий для имитации различных состояний системы HVAC</p>
            </div>
            
            <div class="scenarios-grid">
                <!-- Temperature Spike Scenario -->
                <div class="scenario-card" id="scenario-temperature_spike">
                    <div class="scenario-icon">🌡️</div>
                    <div class="scenario-name">Скачок Температуры</div>
                    <div class="scenario-description">Повышение температуры во всём здании</div>
                    <select class="sensor-select" id="temp-building">
                        <option value="1">🏢 Building 1 (10 sensors)</option>
                        <option value="2">🏢 Building 2 (10 sensors)</option>
                        <option value="3">🏢 Building 3 (12 sensors)</option>
                        <option value="4">🏢 Building 4 (8 sensors)</option>
                        <option value="5">🏢 Building 5 (12 sensors)</option>
                    </select>
                    <div class="intensity-container">
                        <div class="intensity-label">
                            <span>Интенсивность:</span>
                            <span class="intensity-value" id="temp-intensity-value">+10°C</span>
                        </div>
                        <input type="range" class="intensity-slider" id="temp-intensity" 
                               min="5" max="20" value="10" step="1"
                               oninput="document.getElementById('temp-intensity-value').textContent = '+' + this.value + '°C'">
                        <div class="intensity-range">
                            <span>+5°C</span>
                            <span>+20°C</span>
                        </div>
                    </div>
                    <div class="scenario-controls">
                        <button class="btn-trigger" onclick="triggerScenario('temperature_spike')">Запустить</button>
                        <button class="btn-stop" onclick="stopScenario('temperature_spike')" style="display:none;">Стоп</button>
                    </div>
                </div>
                
                <!-- Humidity Drop Scenario -->
                <div class="scenario-card" id="scenario-humidity_drop">
                    <div class="scenario-icon">💧</div>
                    <div class="scenario-name">Падение Влажности</div>
                    <div class="scenario-description">Снижение влажности во всём здании</div>
                    <select class="sensor-select" id="humid-building">
                        <option value="1">🏢 Building 1 (10 sensors)</option>
                        <option value="2">🏢 Building 2 (10 sensors)</option>
                        <option value="3">🏢 Building 3 (12 sensors)</option>
                        <option value="4">🏢 Building 4 (8 sensors)</option>
                        <option value="5">🏢 Building 5 (12 sensors)</option>
                    </select>
                    <div class="intensity-container">
                        <div class="intensity-label">
                            <span>Интенсивность:</span>
                            <span class="intensity-value" id="humid-intensity-value">-15%</span>
                        </div>
                        <input type="range" class="intensity-slider" id="humid-intensity" 
                               min="5" max="30" value="15" step="1"
                               oninput="document.getElementById('humid-intensity-value').textContent = '-' + this.value + '%'">
                        <div class="intensity-range">
                            <span>-5%</span>
                            <span>-30%</span>
                        </div>
                    </div>
                    <div class="scenario-controls">
                        <button class="btn-trigger" onclick="triggerScenario('humidity_drop')">Запустить</button>
                        <button class="btn-stop" onclick="stopScenario('humidity_drop')" style="display:none;">Стоп</button>
                    </div>
                </div>
                
                <!-- CO2 Alarm Scenario -->
                <div class="scenario-card" id="scenario-co2_alarm">
                    <div class="scenario-icon">🌬️</div>
                    <div class="scenario-name">Тревога CO2</div>
                    <div class="scenario-description">Повышение CO2 во всём здании</div>
                    <select class="sensor-select" id="co2-building">
                        <option value="1">🏢 Building 1 (10 sensors)</option>
                        <option value="2">🏢 Building 2 (10 sensors)</option>
                        <option value="3">🏢 Building 3 (12 sensors)</option>
                        <option value="4">🏢 Building 4 (8 sensors)</option>
                        <option value="5">🏢 Building 5 (12 sensors)</option>
                    </select>
                    <div class="intensity-container">
                        <div class="intensity-label">
                            <span>Интенсивность:</span>
                            <span class="intensity-value" id="co2-intensity-value">+400 ppm</span>
                        </div>
                        <input type="range" class="intensity-slider" id="co2-intensity" 
                               min="200" max="800" value="400" step="50"
                               oninput="document.getElementById('co2-intensity-value').textContent = '+' + this.value + ' ppm'">
                        <div class="intensity-range">
                            <span>+200 ppm</span>
                            <span>+800 ppm</span>
                        </div>
                    </div>
                    <div class="scenario-controls">
                        <button class="btn-trigger" onclick="triggerScenario('co2_alarm')">Запустить</button>
                        <button class="btn-stop" onclick="stopScenario('co2_alarm')" style="display:none;">Стоп</button>
                    </div>
                </div>
                
                <!-- Equipment Failure Scenario -->
                <div class="scenario-card" id="scenario-equipment_failure">
                    <div class="scenario-icon">⚠️</div>
                    <div class="scenario-name">Отказ Оборудования</div>
                    <div class="scenario-description">Хаотичные показания во всём здании</div>
                    <select class="sensor-select" id="fail-building">
                        <option value="1">🏢 Building 1 (10 sensors)</option>
                        <option value="2">🏢 Building 2 (10 sensors)</option>
                        <option value="3">🏢 Building 3 (12 sensors)</option>
                        <option value="4">🏢 Building 4 (8 sensors)</option>
                        <option value="5">🏢 Building 5 (12 sensors)</option>
                    </select>
                    <div class="scenario-controls">
                        <button class="btn-trigger" onclick="triggerScenario('equipment_failure')">Запустить</button>
                        <button class="btn-stop" onclick="stopScenario('equipment_failure')" style="display:none;">Стоп</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Building Statistics Cards -->
        <div class="buildings-grid">
            <div class="building-card" id="building-1" data-building="1">
                <div class="building-header">
                    <span class="building-icon">🏢</span>
                    <span class="building-title">Building 1</span>
                    <span class="building-status status-normal" id="status-1">●</span>
                </div>
                <div class="building-metrics">
                    <div class="building-metric">
                        <span class="metric-icon">🌡️</span>
                        <span class="metric-text" id="temp-1">--°C</span>
                    </div>
                    <div class="building-metric">
                        <span class="metric-icon">💧</span>
                        <span class="metric-text" id="humidity-1">--%</span>
                    </div>
                    <div class="building-metric">
                        <span class="metric-icon">🌬️</span>
                        <span class="metric-text" id="co2-1">-- ppm</span>
                    </div>
                </div>
                <div class="building-sensors" id="sensors-1">-- sensors</div>
                <div class="building-scenario-badge" id="badge-1" style="display:none;">
                    <span id="badge-text-1"></span>
                </div>
            </div>

            <div class="building-card" id="building-2" data-building="2">
                <div class="building-header">
                    <span class="building-icon">🏢</span>
                    <span class="building-title">Building 2</span>
                    <span class="building-status status-normal" id="status-2">●</span>
                </div>
                <div class="building-metrics">
                    <div class="building-metric">
                        <span class="metric-icon">🌡️</span>
                        <span class="metric-text" id="temp-2">--°C</span>
                    </div>
                    <div class="building-metric">
                        <span class="metric-icon">💧</span>
                        <span class="metric-text" id="humidity-2">--%</span>
                    </div>
                    <div class="building-metric">
                        <span class="metric-icon">🌬️</span>
                        <span class="metric-text" id="co2-2">-- ppm</span>
                    </div>
                </div>
                <div class="building-sensors" id="sensors-2">-- sensors</div>
                <div class="building-scenario-badge" id="badge-2" style="display:none;">
                    <span id="badge-text-2"></span>
                </div>
            </div>

            <div class="building-card" id="building-3" data-building="3">
                <div class="building-header">
                    <span class="building-icon">🏢</span>
                    <span class="building-title">Building 3</span>
                    <span class="building-status status-normal" id="status-3">●</span>
                </div>
                <div class="building-metrics">
                    <div class="building-metric">
                        <span class="metric-icon">🌡️</span>
                        <span class="metric-text" id="temp-3">--°C</span>
                    </div>
                    <div class="building-metric">
                        <span class="metric-icon">💧</span>
                        <span class="metric-text" id="humidity-3">--%</span>
                    </div>
                    <div class="building-metric">
                        <span class="metric-icon">🌬️</span>
                        <span class="metric-text" id="co2-3">-- ppm</span>
                    </div>
                </div>
                <div class="building-sensors" id="sensors-3">-- sensors</div>
                <div class="building-scenario-badge" id="badge-3" style="display:none;">
                    <span id="badge-text-3"></span>
                </div>
            </div>

            <div class="building-card" id="building-4" data-building="4">
                <div class="building-header">
                    <span class="building-icon">🏢</span>
                    <span class="building-title">Building 4</span>
                    <span class="building-status status-normal" id="status-4">●</span>
                </div>
                <div class="building-metrics">
                    <div class="building-metric">
                        <span class="metric-icon">🌡️</span>
                        <span class="metric-text" id="temp-4">--°C</span>
                    </div>
                    <div class="building-metric">
                        <span class="metric-icon">💧</span>
                        <span class="metric-text" id="humidity-4">--%</span>
                    </div>
                    <div class="building-metric">
                        <span class="metric-icon">🌬️</span>
                        <span class="metric-text" id="co2-4">-- ppm</span>
                    </div>
                </div>
                <div class="building-sensors" id="sensors-4">-- sensors</div>
                <div class="building-scenario-badge" id="badge-4" style="display:none;">
                    <span id="badge-text-4"></span>
                </div>
            </div>

            <div class="building-card" id="building-5" data-building="5">
                <div class="building-header">
                    <span class="building-icon">🏢</span>
                    <span class="building-title">Building 5</span>
                    <span class="building-status status-normal" id="status-5">●</span>
                </div>
                <div class="building-metrics">
                    <div class="building-metric">
                        <span class="metric-icon">🌡️</span>
                        <span class="metric-text" id="temp-5">--°C</span>
                    </div>
                    <div class="building-metric">
                        <span class="metric-icon">💧</span>
                        <span class="metric-text" id="humidity-5">--%</span>
                    </div>
                    <div class="building-metric">
                        <span class="metric-icon">🌬️</span>
                        <span class="metric-text" id="co2-5">-- ppm</span>
                    </div>
                </div>
                <div class="building-sensors" id="sensors-5">-- sensors</div>
                <div class="building-scenario-badge" id="badge-5" style="display:none;">
                    <span id="badge-text-5"></span>
                </div>
            </div>
        </div>
        
        <!-- Charts -->
        <div class="charts-container">
            <div class="chart-card">
                <div class="chart-header">
                    <span style="font-size: 24px;">🌡️</span>
                    <div>
                        <h3 class="chart-title">Температура (Real-time)</h3>
                        <p class="chart-subtitle m-0">Обновление каждые 10 секунд</p>
                    </div>
                </div>
                <canvas id="tempChart"></canvas>
            </div>
            
            <div class="chart-card">
                <div class="chart-header">
                    <span style="font-size: 24px;">💧</span>
                    <div>
                        <h3 class="chart-title">Влажность (Real-time)</h3>
                        <p class="chart-subtitle m-0">Обновление каждые 10 секунд</p>
                    </div>
                </div>
                <canvas id="humidityChart"></canvas>
            </div>
            
            <div class="chart-card">
                <div class="chart-header">
                    <span style="font-size: 24px;">🌬️</span>
                    <div>
                        <h3 class="chart-title">CO2 (Real-time)</h3>
                        <p class="chart-subtitle m-0">Обновление каждые 10 секунд</p>
                    </div>
                </div>
                <canvas id="co2Chart"></canvas>
            </div>
            
            <div class="chart-card">
                <div class="chart-header">
                    <span style="font-size: 24px;">🌍</span>
                    <div>
                        <h3 class="chart-title">Давление (Real-time)</h3>
                        <p class="chart-subtitle m-0">Обновление каждые 10 секунд</p>
                    </div>
                </div>
                <canvas id="pressureChart"></canvas>
            </div>
        </div>
    </div>
    
    <script>
        // Pause/Resume state
        let isPaused = false;
        
        // Initialize Socket.IO connection
        const socket = io();
        
        // Connection status handling
        socket.on('connect', () => {
            console.log('✅ Connected to server');
            if (!isPaused) {
                document.getElementById('connectionStatus').className = 'connection-status connected';
                document.getElementById('statusText').textContent = 'Подключено';
            }
        });
        
        socket.on('disconnect', () => {
            console.log('❌ Disconnected from server');
            document.getElementById('connectionStatus').className = 'connection-status disconnected';
            document.getElementById('statusText').textContent = 'Отключено';
        });
        
        // Pause/Resume toggle
        function togglePause() {
            isPaused = !isPaused;
            const statusDiv = document.getElementById('connectionStatus');
            const statusText = document.getElementById('statusText');
            const pauseBtn = document.getElementById('pauseText');
            
            if (isPaused) {
                statusDiv.className = 'connection-status paused';
                statusText.textContent = 'Приостановлено';
                pauseBtn.textContent = '▶ Возобновить';
                console.log('⏸ Updates paused');
            } else {
                statusDiv.className = 'connection-status connected';
                statusText.textContent = 'Подключено';
                pauseBtn.textContent = '⏸ Приостановить';
                console.log('▶ Updates resumed');
            }
        }
        
        // Initialize Charts
        const chartConfig = {
            type: 'line',
            options: {
                responsive: true,
                maintainAspectRatio: true,
                animation: {
                    duration: 750
                },
                plugins: {
                    legend: {
                        display: true,
                        position: 'top'
                    }
                },
                scales: {
                    y: {
                        beginAtZero: false
                    }
                }
            }
        };
        
        const tempChart = new Chart(document.getElementById('tempChart'), {
            ...chartConfig,
            data: {
                labels: [],
                datasets: [
                    {
                        label: '🏢 Building 1',
                        data: [],
                        borderColor: 'rgb(59, 130, 246)',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        tension: 0.4
                    },
                    {
                        label: '🏢 Building 2',
                        data: [],
                        borderColor: 'rgb(16, 185, 129)',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        tension: 0.4
                    },
                    {
                        label: '🏢 Building 3',
                        data: [],
                        borderColor: 'rgb(239, 68, 68)',
                        backgroundColor: 'rgba(239, 68, 68, 0.1)',
                        tension: 0.4
                    },
                    {
                        label: '🏢 Building 4',
                        data: [],
                        borderColor: 'rgb(245, 158, 11)',
                        backgroundColor: 'rgba(245, 158, 11, 0.1)',
                        tension: 0.4
                    },
                    {
                        label: '🏢 Building 5',
                        data: [],
                        borderColor: 'rgb(139, 92, 246)',
                        backgroundColor: 'rgba(139, 92, 246, 0.1)',
                        tension: 0.4
                    }
                ]
            }
        });
        
        const humidityChart = new Chart(document.getElementById('humidityChart'), {
            ...chartConfig,
            data: {
                labels: [],
                datasets: [
                    {
                        label: '🏢 Building 1',
                        data: [],
                        borderColor: 'rgb(59, 130, 246)',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        tension: 0.4
                    },
                    {
                        label: '🏢 Building 2',
                        data: [],
                        borderColor: 'rgb(16, 185, 129)',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        tension: 0.4
                    },
                    {
                        label: '🏢 Building 3',
                        data: [],
                        borderColor: 'rgb(239, 68, 68)',
                        backgroundColor: 'rgba(239, 68, 68, 0.1)',
                        tension: 0.4
                    },
                    {
                        label: '🏢 Building 4',
                        data: [],
                        borderColor: 'rgb(245, 158, 11)',
                        backgroundColor: 'rgba(245, 158, 11, 0.1)',
                        tension: 0.4
                    },
                    {
                        label: '🏢 Building 5',
                        data: [],
                        borderColor: 'rgb(139, 92, 246)',
                        backgroundColor: 'rgba(139, 92, 246, 0.1)',
                        tension: 0.4
                    }
                ]
            }
        });
        
        const co2Chart = new Chart(document.getElementById('co2Chart'), {
            ...chartConfig,
            data: {
                labels: [],
                datasets: [
                    {
                        label: '🏢 Building 1',
                        data: [],
                        borderColor: 'rgb(59, 130, 246)',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        tension: 0.4
                    },
                    {
                        label: '🏢 Building 2',
                        data: [],
                        borderColor: 'rgb(16, 185, 129)',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        tension: 0.4
                    },
                    {
                        label: '🏢 Building 3',
                        data: [],
                        borderColor: 'rgb(239, 68, 68)',
                        backgroundColor: 'rgba(239, 68, 68, 0.1)',
                        tension: 0.4
                    },
                    {
                        label: '🏢 Building 4',
                        data: [],
                        borderColor: 'rgb(245, 158, 11)',
                        backgroundColor: 'rgba(245, 158, 11, 0.1)',
                        tension: 0.4
                    },
                    {
                        label: '🏢 Building 5',
                        data: [],
                        borderColor: 'rgb(139, 92, 246)',
                        backgroundColor: 'rgba(139, 92, 246, 0.1)',
                        tension: 0.4
                    }
                ]
            }
        });
        
        const pressureChart = new Chart(document.getElementById('pressureChart'), {
            ...chartConfig,
            data: {
                labels: [],
                datasets: [
                    {
                        label: '🏢 Building 1',
                        data: [],
                        borderColor: 'rgb(59, 130, 246)',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        tension: 0.4
                    },
                    {
                        label: '🏢 Building 2',
                        data: [],
                        borderColor: 'rgb(16, 185, 129)',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        tension: 0.4
                    },
                    {
                        label: '🏢 Building 3',
                        data: [],
                        borderColor: 'rgb(239, 68, 68)',
                        backgroundColor: 'rgba(239, 68, 68, 0.1)',
                        tension: 0.4
                    },
                    {
                        label: '🏢 Building 4',
                        data: [],
                        borderColor: 'rgb(245, 158, 11)',
                        backgroundColor: 'rgba(245, 158, 11, 0.1)',
                        tension: 0.4
                    },
                    {
                        label: '🏢 Building 5',
                        data: [],
                        borderColor: 'rgb(139, 92, 246)',
                        backgroundColor: 'rgba(139, 92, 246, 0.1)',
                        tension: 0.4
                    }
                ]
            }
        });
        
        // Handle sensor updates from WebSocket
        socket.on('sensor_update', (data) => {
            // Skip if paused
            if (isPaused) {
                console.log('⏸ Skipping update (paused)');
                return;
            }
            
            console.log('📡 Received sensor update:', data);
            
            if (data.readings && data.readings.length > 0) {
                // Refresh building stats on each update
                loadBuildingStats();
                
                // Update charts
                updateCharts(data.readings);
            }
        });
        
        function updateMetrics(readings) {
            let tempSum = 0, humiditySum = 0, co2Sum = 0, pressureSum = 0;
            let tempMin = Infinity, tempMax = -Infinity;
            let humidityMin = Infinity, humidityMax = -Infinity;
            let co2Min = Infinity, co2Max = -Infinity;
            let pressureMin = Infinity, pressureMax = -Infinity;
            
            readings.forEach(reading => {
                if (reading.temperature) {
                    tempSum += reading.temperature;
                    tempMin = Math.min(tempMin, reading.temperature);
                    tempMax = Math.max(tempMax, reading.temperature);
                }
                if (reading.humidity) {
                    humiditySum += reading.humidity;
                    humidityMin = Math.min(humidityMin, reading.humidity);
                    humidityMax = Math.max(humidityMax, reading.humidity);
                }
                if (reading.co2) {
                    co2Sum += reading.co2;
                    co2Min = Math.min(co2Min, reading.co2);
                    co2Max = Math.max(co2Max, reading.co2);
                }
                if (reading.pressure) {
                    pressureSum += reading.pressure;
                    pressureMin = Math.min(pressureMin, reading.pressure);
                    pressureMax = Math.max(pressureMax, reading.pressure);
                }
            });
            
            const count = readings.length;
            
            document.getElementById('avgTemp').textContent = (tempSum / count).toFixed(1) + '°C';
            document.getElementById('tempRange').textContent = `Range: ${tempMin.toFixed(1)}°C - ${tempMax.toFixed(1)}°C`;
            
            document.getElementById('avgHumidity').textContent = (humiditySum / count).toFixed(1) + '%';
            document.getElementById('humidityRange').textContent = `Range: ${humidityMin.toFixed(1)}% - ${humidityMax.toFixed(1)}%`;
            
            document.getElementById('avgCO2').textContent = Math.round(co2Sum / count) + ' ppm';
            document.getElementById('co2Range').textContent = `Range: ${Math.round(co2Min)} - ${Math.round(co2Max)} ppm`;
            
            document.getElementById('avgPressure').textContent = (pressureSum / count).toFixed(1) + ' bar';
            document.getElementById('pressureRange').textContent = `Range: ${pressureMin.toFixed(1)} - ${pressureMax.toFixed(1)} bar`;
        }
        
        function updateCharts(readings) {
            const now = new Date().toLocaleTimeString('ru-RU');
            const maxPoints = 20;
            
            // Group readings by building_id
            const buildingData = {
                1: {temp: [], humidity: [], co2: [], pressure: []},
                2: {temp: [], humidity: [], co2: [], pressure: []},
                3: {temp: [], humidity: [], co2: [], pressure: []},
                4: {temp: [], humidity: [], co2: [], pressure: []},
                5: {temp: [], humidity: [], co2: [], pressure: []}
            };
            
            readings.forEach(r => {
                const buildingId = r.building_id;
                if (buildingId && buildingData[buildingId]) {
                    if (r.temperature) buildingData[buildingId].temp.push(r.temperature);
                    if (r.humidity) buildingData[buildingId].humidity.push(r.humidity);
                    if (r.co2) buildingData[buildingId].co2.push(r.co2);
                    if (r.pressure) buildingData[buildingId].pressure.push(r.pressure);
                }
            });
            
            // Calculate averages per building
            const buildingAvgs = {};
            for (let buildingId in buildingData) {
                const data = buildingData[buildingId];
                buildingAvgs[buildingId] = {
                    temp: data.temp.length ? data.temp.reduce((a,b) => a+b, 0) / data.temp.length : null,
                    humidity: data.humidity.length ? data.humidity.reduce((a,b) => a+b, 0) / data.humidity.length : null,
                    co2: data.co2.length ? data.co2.reduce((a,b) => a+b, 0) / data.co2.length : null,
                    pressure: data.pressure.length ? data.pressure.reduce((a,b) => a+b, 0) / data.pressure.length : null
                };
            }
            
            // Update all 5 datasets in each chart
            addMultiBuildingData(tempChart, now, buildingAvgs, 'temp', maxPoints);
            addMultiBuildingData(humidityChart, now, buildingAvgs, 'humidity', maxPoints);
            addMultiBuildingData(co2Chart, now, buildingAvgs, 'co2', maxPoints);
            addMultiBuildingData(pressureChart, now, buildingAvgs, 'pressure', maxPoints);
        }
        
        function addMultiBuildingData(chart, label, buildingAvgs, metric, maxPoints) {
            // Add timestamp to labels if not exists
            if (!chart.data.labels.includes(label)) {
                chart.data.labels.push(label);
            }
            
            // Update each building's dataset (5 datasets: 0-4 for buildings 1-5)
            for (let i = 0; i < 5; i++) {
                const buildingId = i + 1;
                const value = buildingAvgs[buildingId][metric];
                
                if (value !== null) {
                    chart.data.datasets[i].data.push(value);
                } else {
                    chart.data.datasets[i].data.push(null);
                }
            }
            
            // Keep only last maxPoints
            if (chart.data.labels.length > maxPoints) {
                chart.data.labels.shift();
                chart.data.datasets.forEach(dataset => {
                    dataset.data.shift();
                });
            }
            
            chart.update('none'); // Update without animation for smoother real-time
        }
        
        // Load historical data on page load
        async function loadHistoricalData() {
            try {
                console.log('📊 Loading historical data for all sensors...');
                const response = await fetch('/api/readings/latest');
                const result = await response.json();
                
                if (result.success && result.data && result.data.length > 0) {
                    console.log(`✅ Loaded ${result.data.length} sensor readings`);
                    
                    // Group by building and calculate initial averages
                    const buildingData = {};
                    result.data.forEach(reading => {
                        const buildingId = reading.building_id;
                        if (!buildingData[buildingId]) {
                            buildingData[buildingId] = {
                                temp: [],
                                humidity: [],
                                co2: [],
                                pressure: []
                            };
                        }
                        if (reading.temperature) buildingData[buildingId].temp.push(reading.temperature);
                        if (reading.humidity) buildingData[buildingId].humidity.push(reading.humidity);
                        if (reading.co2) buildingData[buildingId].co2.push(reading.co2);
                        if (reading.pressure) buildingData[buildingId].pressure.push(reading.pressure);
                    });
                    
                    // Add one initial point per building to each chart
                    const now = new Date().toLocaleTimeString('ru-RU');
                    
                    for (let buildingId = 1; buildingId <= 5; buildingId++) {
                        const data = buildingData[buildingId];
                        if (data) {
                            const tempAvg = data.temp.length ? data.temp.reduce((a,b) => a+b) / data.temp.length : 0;
                            const humidityAvg = data.humidity.length ? data.humidity.reduce((a,b) => a+b) / data.humidity.length : 0;
                            const co2Avg = data.co2.length ? data.co2.reduce((a,b) => a+b) / data.co2.length : 0;
                            const pressureAvg = data.pressure.length ? data.pressure.reduce((a,b) => a+b) / data.pressure.length : 0;
                            
                            // Add to dataset (buildingId - 1 because arrays are 0-indexed)
                            const idx = buildingId - 1;
                            tempChart.data.datasets[idx].data.push(tempAvg);
                            humidityChart.data.datasets[idx].data.push(humidityAvg);
                            co2Chart.data.datasets[idx].data.push(co2Avg);
                            pressureChart.data.datasets[idx].data.push(pressureAvg);
                        }
                    }
                    
                    // Add timestamp label
                    tempChart.data.labels.push(now);
                    humidityChart.data.labels.push(now);
                    co2Chart.data.labels.push(now);
                    pressureChart.data.labels.push(now);
                    
                    // Update all charts
                    tempChart.update();
                    humidityChart.update();
                    co2Chart.update();
                    pressureChart.update();
                    
                    console.log('✅ Charts populated with historical data');
                } else {
                    console.warn('⚠️ No historical data available');
                }
            } catch (err) {
                console.error('❌ Failed to load historical data:', err);
            }
        }
        
        // Fetch initial data on load
        fetch('/api/readings/latest')
            .then(res => res.json())
            .then(data => {
                if (data.success && data.data) {
                    // Building stats loaded separately via loadBuildingStats()
                    console.log('✅ Initial sensor data loaded');
                }
            })
            .catch(err => console.error('❌ Failed to fetch initial data:', err));
        
        // Load historical data for charts
        loadHistoricalData();
        
        // SCENARIO CONTROL FUNCTIONS
        socket.on('scenario_triggered', (data) => {
            console.log('🎬 Scenario triggered:', data);
            const card = document.getElementById(`scenario-${data.type}`);
            if (card) {
                card.classList.add('active');
                card.querySelector('.btn-trigger').style.display = 'none';
                card.querySelector('.btn-stop').style.display = 'block';
            }
        });
        
        socket.on('scenario_stopped', (data) => {
            console.log('🛑 Scenario stopped:', data);
            const type = data.type === 'all' ? 'all' : data.type;
            
            if (type === 'all') {
                document.querySelectorAll('.scenario-card').forEach(card => {
                    card.classList.remove('active');
                    card.querySelector('.btn-trigger').style.display = 'block';
                    card.querySelector('.btn-stop').style.display = 'none';
                });
            } else {
                const card = document.getElementById(`scenario-${type}`);
                if (card) {
                    card.classList.remove('active');
                    card.querySelector('.btn-trigger').style.display = 'block';
                    card.querySelector('.btn-stop').style.display = 'none';
                }
            }
        });
        
        // Load building statistics
        async function loadBuildingStats() {
            try {
                const response = await fetch('/api/buildings/stats');
                const result = await response.json();
                
                if (result.success && result.buildings) {
                    result.buildings.forEach(building => {
                        const buildingId = building.building_id;
                        
                        // Update temperature
                        const tempEl = document.getElementById(`temp-${buildingId}`);
                        if (tempEl) tempEl.textContent = building.avg_temperature + '°C';
                        
                        // Update humidity
                        const humidityEl = document.getElementById(`humidity-${buildingId}`);
                        if (humidityEl) humidityEl.textContent = building.avg_humidity + '%';
                        
                        // Update CO2
                        const co2El = document.getElementById(`co2-${buildingId}`);
                        if (co2El) co2El.textContent = building.avg_co2 + ' ppm';
                        
                        // Update sensor count
                        const sensorsEl = document.getElementById(`sensors-${buildingId}`);
                        if (sensorsEl) sensorsEl.textContent = building.sensor_count + ' sensors';
                        
                        // Update status indicator
                        const statusEl = document.getElementById(`status-${buildingId}`);
                        if (statusEl) {
                            statusEl.className = 'building-status';
                            if (building.status === 'normal') {
                                statusEl.classList.add('status-normal');
                            } else if (building.status === 'warning') {
                                statusEl.classList.add('status-warning');
                            } else if (building.status === 'critical') {
                                statusEl.classList.add('status-critical');
                            }
                        }
                        
                        // Show/hide scenario badge
                        const badgeEl = document.getElementById(`badge-${buildingId}`);
                        const badgeTextEl = document.getElementById(`badge-text-${buildingId}`);
                        if (building.active_scenarios && building.active_scenarios.length > 0) {
                            if (badgeEl && badgeTextEl) {
                                const scenarioName = building.active_scenarios[0].replace('_', ' ').toUpperCase();
                                badgeTextEl.textContent = `🔥 ${scenarioName} ACTIVE`;
                                badgeEl.style.display = 'block';
                            }
                        } else {
                            if (badgeEl) badgeEl.style.display = 'none';
                        }
                    });
                    
                    console.log('🏢 Building stats updated');
                }
            } catch (err) {
                console.error('❌ Failed to load building stats:', err);
            }
        }
        
        // Check active scenarios on page load
        async function checkActiveScenarios() {
            try {
                const response = await fetch('/api/scenarios/status');
                const result = await response.json();
                
                if (result.success && result.scenarios) {
                    Object.entries(result.scenarios).forEach(([type, status]) => {
                        if (status.active) {
                            const card = document.getElementById(`scenario-${type}`);
                            if (card) {
                                card.classList.add('active');
                                card.querySelector('.btn-trigger').style.display = 'none';
                                card.querySelector('.btn-stop').style.display = 'block';
                            }
                        }
                    });
                }
            } catch (err) {
                console.error('Failed to check active scenarios:', err);
            }
        }
        
        // Load initial data on page load
        loadBuildingStats();
        checkActiveScenarios();
        
        // Refresh building stats every 2 seconds
        setInterval(loadBuildingStats, 2000);
        
        async function triggerScenario(type) {
            // Get building_id and intensity based on scenario type
            let buildingId, intensity;
            
            if (type === 'temperature_spike') {
                buildingId = parseInt(document.getElementById('temp-building').value);
                intensity = parseInt(document.getElementById('temp-intensity').value);
            } else if (type === 'humidity_drop') {
                buildingId = parseInt(document.getElementById('humid-building').value);
                intensity = parseInt(document.getElementById('humid-intensity').value);
            } else if (type === 'co2_alarm') {
                buildingId = parseInt(document.getElementById('co2-building').value);
                intensity = parseInt(document.getElementById('co2-intensity').value);
            } else if (type === 'equipment_failure') {
                buildingId = parseInt(document.getElementById('fail-building').value);
                intensity = 0;
            }
            
            console.log(`🎬 Triggering scenario: ${type}, building: ${buildingId}, intensity: ${intensity}`);
            
            try {
                const response = await fetch('/api/scenarios/trigger', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        type: type,
                        building_id: buildingId,
                        intensity: intensity,
                        duration: 300
                    })
                });
                const result = await response.json();
                console.log('✅ Scenario triggered:', result);
                
                if (result.success) {
                    console.log(`🏢 Affected ${result.sensor_count} sensors in Building ${buildingId}`);
                } else {
                    alert('Ошибка: ' + result.error);
                }
            } catch (err) {
                console.error('❌ Error triggering scenario:', err);
                alert('Ошибка при запуске сценария: ' + err.message);
            }
        }
        
        async function stopScenario(type) {
            console.log(`🛑 Stopping scenario: ${type}`);
            try {
                const response = await fetch('/api/scenarios/stop', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({type})
                });
                const result = await response.json();
                console.log('Response:', result);
            } catch (err) {
                console.error('Error stopping scenario:', err);
            }
        }
    </script>
</body>
</html>
